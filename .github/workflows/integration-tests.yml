name: Integration Tests

on:
  pull_request:
    branches: [ main ]

jobs:
  integration-tests:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v3

    - name: Set up Go
      uses: actions/setup-go@v4
      with:
        go-version: '1.21'

    - name: Create k3d cluster
      uses: AbsaOSS/k3d-action@v2
      with:
        cluster-name: "test-cluster"
        args: >-
          --agents 1
          --no-lb
          --k3s-arg "--disable=traefik,servicelb,metrics-server@server:*"

    - name: Run integration tests
      run: |
        go test -v ./... -tags=integration 